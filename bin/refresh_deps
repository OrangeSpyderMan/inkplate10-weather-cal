#!/usr/bin/env bash
set -euo pipefail

# refresh_deps - upgrade pip/setuptools/wheel in a virtualenv and reinstall requirements
# Usage:
#   bin/refresh_deps [VENV_DIR] [REQUIREMENTS_FILE]
# Defaults:
#   VENV_DIR=/srv/inkplate/inkplate_venv
#   REQUIREMENTS_FILE=<repo_root>/server/requirements.txt

DEFAULT_VENV_DIR="/srv/inkplate/inkplate_venv"
SCRIPT_DIR=$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)
REPO_ROOT=$(cd "$SCRIPT_DIR/.." && pwd)
DEFAULT_REQ_FILE="$REPO_ROOT/server/requirements.txt"

# Allow overriding via options or legacy positional args.
# Usage:
#   bin/refresh_deps [VENV_DIR] [REQUIREMENTS_FILE]
#   bin/refresh_deps --venv PATH --requirements PATH

VENV_DIR="${DEFAULT_VENV_DIR}"
REQ_FILE="${DEFAULT_REQ_FILE}"
USER_SPECIFIED=0

print_usage() {
  cat <<EOF
Usage: ${0##*/} [VENV_DIR] [REQUIREMENTS_FILE]
   or: ${0##*/} [--venv VENV_DIR] [--requirements REQUIREMENTS_FILE]

Defaults:
  VENV_DIR=${DEFAULT_VENV_DIR}
  REQUIREMENTS_FILE=${DEFAULT_REQ_FILE}
EOF
}

# Simple arg parsing: if first arg starts with '-' use option parsing
if [ "$#" -gt 0 ]; then
  case "$1" in
    -h|--help)
      print_usage
      exit 0
      ;;
  esac
fi

if [ "$#" -gt 0 ] && [[ "$1" == --* || "$1" == -* ]]; then
  # option-style parsing
  while [ "$#" -gt 0 ]; do
    case "$1" in
      -v|--venv)
        shift
        VENV_DIR="$1"
        USER_SPECIFIED=1
        ;;
      -r|--requirements|--req)
        shift
        REQ_FILE="$1"
        USER_SPECIFIED=1
        ;;
      -h|--help)
        print_usage
        exit 0
        ;;
      *)
        echo "Unknown option: $1" >&2
        print_usage
        exit 2
        ;;
    esac
    shift || true
  done
else
  # legacy positional args
  if [ "$#" -ge 1 ]; then
    VENV_DIR="$1"
    USER_SPECIFIED=1
  fi
  if [ "$#" -ge 2 ]; then
    REQ_FILE="$2"
    USER_SPECIFIED=1
  fi
fi

# If no runtime options/positional args provided, echo the defaults before running
if [ "$USER_SPECIFIED" -eq 0 ]; then
  echo "No runtime options provided; using defaults:";
  echo "  VENV_DIR=$VENV_DIR"
  echo "  REQUIREMENTS_FILE=$REQ_FILE"
else
  echo "Using provided values:"
  echo "  VENV_DIR=$VENV_DIR"
  echo "  REQUIREMENTS_FILE=$REQ_FILE"
fi

PY="$VENV_DIR/bin/python"

if [ ! -x "$PY" ]; then
  echo "ERROR: Python not found or not executable at: $PY" >&2
  echo "If your venv is in a different location pass it as the first argument or use --venv." >&2
  exit 2
fi

if [ ! -f "$REQ_FILE" ]; then
  echo "ERROR: Requirements file not found: $REQ_FILE" >&2
  exit 3
fi

echo "Upgrading pip, setuptools and wheel..."
"$PY" -m pip install --upgrade pip setuptools wheel

echo "Installing packages from $REQ_FILE..."
"$PY" -m pip install -r "$REQ_FILE"

echo "Done. Current pip: $("$PY" -m pip --version)"

echo "Installed packages (top 30):"
"$PY" -m pip list --format=columns | sed -n '1,30p'

echo "refresh_deps completed successfully"
